
--A-- -------creacion de esquemas--------
	  -----------------------------------
	  create schema Viajes
	  go
	  create schema Pago
	  go
	  create schema Clientes
	  go


	  ---------------------------------------------------
--B-- -------Particiones y esquemas de asignacion--------
	  ---------------------------------------------------


	  -------Particion---------
	  CREATE PARTITION FUNCTION pf_cantidades (int)
	  AS RANGE LEFT FOR VALUES (1000,3000);
	  go

	  CREATE PARTITION SCHEME ps_cantidad
	  AS 
      PARTITION pf_cantidad
      TO (IAEJ_PARTICION_FG,IAEJ_PARTICION_FG2,"Primary")
	  GO


	  ---------------------------------------------------
--C-- --------------COMPRESION DDE DATOS-----------------
	  ---------------------------------------------------


	  -------Tabla Autobuses---------
	  create table Viajes.Autobuses (
	  Matricula varchar(10) not null,
	  Marca varchar(30) not null,
	  color varchar(20) not null,
	  Cantidad_Asientos int not null,
	  idAutobus int not null,
	  )
	  on "Primary"
	  with (data_compression=Page)


	  -------Corridas---------
	  create table Viajes.Corridas (
	  id_viaje int not null,
	  horarioSalida date not null,
	  fechaSalida date not null,
	  Ciudades_id_ciudades int not null,
	  costos float not null,
	  horaLLegada date not null,
	  fechaLLegada date not null,
	  Autobuses_idAutobus int not null,
	  asientosOcupados int not null,
	  Ciudades_id_ciudades1 int not null
	  )
	  on "Primary"
	  with (data_compression=Row)


	  -------Ciudades---------
	  create table Viajes.Ciudades (
	  id_ciudades int not null,
	  nombre_ciudad varchar(80) not null
	  )
	  on "Primary"
	  with (data_compression=Row)


	  -------Venta_tickets---------
	  create table Pago.Venta_tickets (
	  id_ticket int not null,
	  Viajes_salientes_id_viaje int not null,
	  fechaCompra date not null,
	  noAsiento int not null,
	  estatus char  not null,
	  totalPagar float not null,
	  Informacion_pago_id_pago int not null,
	  Clientes_id_usuario  varchar(16)
	  )
	  on ps_cantidad(totalPagar)
	  with (data_compression=Row)


	  -------Informacion _pago---------
	  create table Pago.Informacion_pago (
	  id_pago int not null,
	  num_tarjeta varchar(16) not null,
	  fecha_expiracion date not null,
	  cvv int not null,
	  Clientes_id_usuario varchar(15) not null
	  )
	  on IAEJ_SECUNDARY_FG
	  with (data_compression=Row)


	  -------Clientes---------
	    create table Clientes.Clientes (
	  id_usuario varchar(16) not null,
	  nombre_usuario varchar(50) not null,
	  curp varchar(18) not null
	  )
	  on IAEJ_PRIORITY_FG
	  with (data_compression=Row)


	  -------Miembros---------
	   create table Clientes.Miembros (
	  Membresias_idMembresia int not null,
	  Usuarios_frecuentes_id_usuario varchar(16) not null,
	  fechaInicio date not null,
	  fechaFin date not null
	  )
	  on IAEJ_PRIORITY_FG
	  with (data_compression=Page)


	  -------Membresias---------
	  create table Clientes.Membresias (
	  idMembresia int not null,
	  nombre varchar(60) not null,
	  Descuento float not null,
	  estatus char not null,
	  costo float not null
	  )
	  on IAEJ_PRIORITY_FG
	  with (data_compression=Page)


	  ---------------------------------------------------
--D-- -----------RESTRICCIONES DE INTEGRIDAD-------------
	  ---------------------------------------------------

	  -------Primary key---------
	  alter  table Viajes.Autobuses add constraint Autobuses_PK primary  key (idAutobus)
	  alter  table Viajes.Corridas  add constraint Viajes_salientes_PK primary  key (id_viaje)
	  alter  table Viajes.Ciudades  add constraint Destinos_PK primary  key (id_Ciudades)
	  alter  table Pago.Venta_tickets add constraint Venta_tickets_PK primary  key (id_ticket)
	  alter  table Pago.Informacion_pago add constraint Informacion_pago_PK primary  key (Id_pago)
	  alter  table Clientes.Clientes add constraint Usuarios_frecuentes_PK primary  key (id_usuario)
	  alter  table Clientes.Membresias add constraint Membresias_PK primary  key (curp)

	  -------Unique---------
	  alter  table Viajes.Autobuses add constraint Uq_matricula unique (matricula)
	  alter  table Viajes.Ciudades add constraint Uq_nombre_ciudad unique (nombre_ciudad)
	  alter  table Pago.Informacion_pago add constraint Uq_num_tarjeta unique (num_tarjeta)
	  alter  table Pago.Venta_tickets add constraint Uq_noAsiento unique (noAsiento)
	  alter  table Clientes.Clientes add constraint Uq_curp unique (curp)


	  -------Foreing key---------
	  alter  table Viajes.Corridas  add constraint Corridas_Autobuses_saliente_FK foreign key (Autobuses_idAutobus) references VIAJES.Autobuses (idAutobus)
	  alter  table Viajes.Corridas  add constraint Corridas_Ciudaes_Destino_FK foreign  key (id_ciudades)  references VIAJES.Ciudades (idCiudades)
	  alter  table Viajes.Corridas  add constraint Corridas_Ciudaes_Origen_FK foreign  key (id_ciudades1)  references VIAJES.Autobuses (idCiudades)

	  alter  table Pago.Venta_tickets add constraint Venta_tickets_Viajes_salientes_FK foreign key (Viajes_salientes_id_viaje) references Viajes.Corridas (id_viaje)
	  alter  table Pago.Venta_tickets add constraint Venta_tickets_Informacion_pago_FK foreign key (Informacion_pago_id_pago) references Pago.Informacion_pago (id_pago)
	  alter  table Pago.Venta_tickets add constraint Venta_tickets_Clientes_FK foreign key (Clientes_id_usuario) references Clientes.Clientes (id_usuario)

	  alter  table Clientes.Miembros add constraint Miembros_Membresias_FK foreign key (Membresias_idMembresia) references Clientes.Membresias (idMembresia)
	  alter  table Clientes.Miembros add constraint Miembros_Usuarios_frecuentes_FK foreign key (Usuarios_frecuentes_id_usuario) references Clientes.Clientes (id_usuario)

	  alter  table Pago.Informacion_pago add constraint Informacion_pago__Clientes_FK foreign key (Clientes_id_usuario) references Clientes.Clientes (id_usuario)

	  -------Restricciones de dominio---------
	  alter table Viajes.Corridas add constraint Chk_Costos check (Costos>0)
	  alter table Viajes.Corridas add constraint Chk_asientos check (asientosOcupados>0)
	  alter table Viajes.Autobuses add constraint Chk_cantAsientos check (cantidad_asientos between 10 and 40)
	  alter table Pago.venta_tickets add constraint Chk_noAsiento check (noAsiento between 10 and 40)
	  alter table Pago.venta_tickets add constraint Chk_estatus check (estatus IN ('0','1'))
	  alter table Viajes.Ciudades add constraint Chk_idCiudades check (id_ciudades>=1 and id_ciudades<=80)
	  alter table Pago.Informacion_pago add constraint Chk_numTarjeta check (num_tarjeta LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]')
	  alter table Pago.Informacion_pago add constraint Chk_fechaExp check (fecha_expiracion BETWEEN YEAR(GETDATE()) AND 2030)
	  alter table Pago.Informacion_pago add constraint Chk_cvv check (cvv LIKE '[0-9][0-9][0-9]')
	  


	  -------Defaults---------
	   alter  table Viajes.Corridas  add constraint Df_asientos_ocup default 0 for asientosOcupados
	   alter  table Pago.Venta_tickets add constraint Df_total_pagar default 0.00 for totalPagar
	   alter  table Clientes.Membresias add constraint Df_estatus default "Inactica" for Estatus
	   alter  table Clientes.Membresias add constraint Df_Descuento default .10*totalpagar for Descuento
	   alter  table Viajes.Autobuses add constraint Df_cantidad_asientos default 36 for cantidad_asientos
